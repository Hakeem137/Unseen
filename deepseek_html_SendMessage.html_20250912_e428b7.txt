<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إرسال رسالة — بسيط</title>
  <style>
    :root{--bg:#f5f7fb;--card:#fff;--accent:#5a3fff;--muted:#6b7280}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial;background:var(--bg);color:#071033}
    .container{max-width:840px;margin:34px auto;padding:20px}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 8px 24px rgba(9,30,66,0.06)}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-weight:800;font-size:18px}
    .muted{color:var(--muted);font-size:13px}

    textarea{width:100%;min-height:160px;border-radius:10px;border:1px solid #e6e9ef;padding:12px;font-size:15px;resize:vertical}
    .controls{display:flex;gap:10px;align-items:center;margin-top:12px}
    .btn{background:var(--accent);color:white;padding:10px 14px;border-radius:10px;border:none;font-weight:800;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #e6e9ef;color:var(--muted)}
    .sender-info{display:flex;gap:8px;align-items:center}
    .sender-name{font-weight:700;color:#0f172a}
    .hint{font-size:13px;color:var(--muted);margin-top:10px}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="top">
        <div>
          <div class="title">اكتب رسالة</div>
          <div class="muted">خلي الكلام بسيط — مربع كتابة واحد وزر إرسال.</div>
        </div>
        <div class="sender-info">
          <button id="revealBtn" class="btn ghost">أظهر اسم المرسل</button>
          <div id="senderLabel" class="muted">(المرسل: مجهول)</div>
        </div>
      </div>

      <form id="msgForm" style="margin-top:16px" autocomplete="off">
        <textarea id="message" placeholder="اكتب اعترافك أو رسالتك هنا..." maxlength="1500"></textarea>
        <div class="controls">
          <button id="sendBtn" class="btn" type="submit">أرسل</button>
          <button id="cancelBtn" type="button" class="btn ghost">إلغاء</button>
          <div class="muted" id="charCount">0 / 1500</div>
        </div>
        <p class="hint">لو ضغطت "أظهر اسم المرسل" ومش مسجّل دخول، هيطلب منك تسجيل الدخول. بعد التسجيل هيظهر اسم حسابك جنب الزر ويُستخدم كاسم مرئي.</p>
      </form>
    </div>
  </div>

  <!-- Netlify identity + firebase (compat) -->
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // إعدادات Firebase (نفس الإعدادات في Index.html)
    const firebaseConfig = {
      apiKey: "AIzaSyB7uWrWJ1v_o3fqx0442wIkrAfTnPn84Mo",
      authDomain: "unseen-93dd8.firebaseapp.com",
      projectId: "unseen-93dd8",
      storageBucket: "unseen-93dd8.firebasestorage.app",
      messagingSenderId: "142670337449",
      appId: "1:142670337449:web:f41e9b5ebbb433378060b8",
      measurementId: "G-SPL7YN9LZ1"
    };

    // init
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    netlifyIdentity.init();

    // عناصر الواجهة
    const revealBtn = document.getElementById('revealBtn');
    const senderLabel = document.getElementById('senderLabel');
    const msgEl = document.getElementById('message');
    const charCount = document.getElementById('charCount');
    const form = document.getElementById('msgForm');
    const cancelBtn = document.getElementById('cancelBtn');

    let revealState = false; // هل اسم المرسل مكشوف
    let targetUsername = null; // اسم المستخدم الهدف من параметر URL

    // الحصول على اسم المستخدم الهدف من параметر URL
    function getTargetUsername() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('u');
    }

    function updateSenderLabel(user){
      if(revealState && user){
        const name = user.user_metadata && user.user_metadata.full_name ? user.user_metadata.full_name : (user.email || user.id);
        senderLabel.textContent = 'المرسل: ' + name;
      } else {
        senderLabel.textContent = '(المرسل: مجهول)';
      }
    }

    // عند تحميل الصفحة، تأكّد من حالة الدخول
    function currentNetlifyUser(){ return netlifyIdentity.currentUser(); }

    // التعامل مع زر الكشف عن اسم المرسل
    revealBtn.addEventListener('click', ()=>{
      const user = currentNetlifyUser();
      if(user){
        // لو مسجل، بدل الحالة وحدث التسمية
        revealState = !revealState;
        revealBtn.textContent = revealState ? 'اخفِ اسم المرسل' : 'أظهر اسم المرسل';
        updateSenderLabel(user);
        return;
      }

      // لو مش مسجل: نطلب منه التسجيل
      const ok = confirm('عشان يظهر اسم المرسل لازم تسجّل دخول. هل تريد تسجيل الدخول الآن؟');
      if(!ok) return;
      // افتح نافذة Netlify Identity
      netlifyIdentity.open();
    });

    // بعد تسجيل الدخول من Netlify: نجيب المستخدم ونحدّث الواجهة
    netlifyIdentity.on('login', (user) => {
      // أغلق الودجت
      netlifyIdentity.close();
      // فعّل الكشف تلقائياً بعد تسجيل الدخول (لو كان المستخدم ضغط الكشف)
      revealState = true;
      revealBtn.textContent = 'اخفِ اسم المرسل';
      updateSenderLabel(user);
    });

    // عند تسجيل الخروج
    netlifyIdentity.on('logout', ()=>{
      revealState = false;
      revealBtn.textContent = 'أظهر اسم المرسل';
      updateSenderLabel(null);
    });

    // عداد الأحرف
    msgEl.addEventListener('input', ()=>{ charCount.textContent = msgEl.value.length + ' / 1500'; });

    // زر الإلغاء - العودة للصفحة السابقة
    cancelBtn.addEventListener('click', ()=>{
      window.history.back();
    });

    // إرسال الرسالة: نحفظها في Firestore مع visibleName اعتماداً على revealState
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = msgEl.value.trim();
      if(!text) return alert('اكتب رسالة عشان تبعتها');
      const user = currentNetlifyUser();

      if(revealState && !user){
        // حالة نادرة: حاول المستخدم كشف الاسم لكنه خرج قبل الإرسال
        const ok = confirm('عشان تبيّن اسم المرسل لازم تسجّل دخول الآن. فتح صفحة تسجيل؟');
        if(ok){ netlifyIdentity.open(); }
        return;
      }

      // الحصول على اسم المستخدم الهدف
      targetUsername = getTargetUsername();
      if (!targetUsername) {
        alert('لم يتم تحديد مستلم للرسالة');
        return;
      }

      // جهز الحقول للحفظ
      const visibleName = (revealState && user) ? (user.user_metadata && user.user_metadata.full_name ? user.user_metadata.full_name : (user.email || user.id)) : 'مجهول';
      const senderUid = (user ? user.id : null);

      try{
        await db.collection('messages').add({
          toUsername: targetUsername,
          messageText: text,
          visibleName: visibleName,
          anonymous: !revealState,
          senderUid: senderUid,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        alert('تم إرسال الرسالة!');
        msgEl.value = '';
        charCount.textContent = '0 / 1500';
        
        // العودة للصفحة السابقة بعد إرسال ناجح
        setTimeout(() => {
          window.history.back();
        }, 1000);
      }catch(err){
        console.error(err);
        alert('حدث خطأ أثناء الإرسال: ' + (err.message || err));
      }
    });

    // تهيئة واجهة الاسم عند التحميل
    document.addEventListener('DOMContentLoaded', ()=>{
      updateSenderLabel(currentNetlifyUser());
      
      // التحقق من وجود مستلم
      targetUsername = getTargetUsername();
      if (!targetUsername) {
        alert('لم يتم تحديد مستلم للرسالة');
        window.location.href = 'Index.html';
      }
    });
  </script>
</body>
</html>