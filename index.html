<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unseen — الصفحة التعريفية</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* (styles preserved from original file for brevity) */
    :root{ --primary:#5a3fff; --accent:#06b6d4; --muted:#64748b; --bg:#ffffff; --card:rgba(10,11,13,0.04); --radius:14px; }
    [dir="rtl"]{ --flow:row-reverse; }
    *{box-sizing:border-box} html,body{height:100%;}
    body{margin:0;font-family:"Cairo", system-ui, -apple-system, "Inter", sans-serif;background:var(--bg);color:#081029;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:background .25s,color .25s;}
    body.dark{ --bg:#07102a; background:#07102a; color:#e6eef8; }
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{display:inline-grid;place-items:center;width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));color:white;font-weight:700}
    .hero{padding:48px 20px;text-align:center}
    .hero-inner{max-width:980px;margin:0 auto;display:grid;grid-template-columns:1fr;gap:18px;align-items:center}
    .eyebrow{display:inline-block;background:rgba(90,63,255,0.08);color:var(--primary);padding:6px 10px;border-radius:999px;font-weight:700}
    .hero h2{font-size:2.1rem;margin:6px 0}
    .hero p{color:var(--muted);margin:0 0 12px}
    .hero-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
    .btn{display:inline-flex;gap:10px;align-items:center;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:white}
    .btn-ghost{background:transparent;border:1px solid rgba(8,16,41,0.06);color:inherit}
    .profile-link{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:999px;background:var(--card);font-weight:600}
    .features{padding:20px;max-width:1100px;margin:6px auto;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(8,16,41,0.04);transition:transform .2s,box-shadow .2s}
    .card:hover{transform:translateY(-6px);box-shadow:0 24px 52px rgba(8,16,41,0.06)}
    .muted{color:var(--muted)}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,0.5);z-index:60}
    .modal.open{display:grid}
    .modal-card{background:var(--bg);padding:18px;border-radius:12px;width:380px;max-width:94%}
    input,textarea{padding:10px;border-radius:8px;border:1px solid rgba(8,16,41,0.06);font-family:inherit}
    .admin-panel{display:none;position:fixed;top:0;right:0;bottom:0;width:320px;background:var(--bg);z-index:100;box-shadow:-4px 0 20px rgba(0,0,0,0.1);padding:20px;overflow-y:auto}
    .admin-panel.open{display:block}
    .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--primary);color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1000;display:none;align-items:center;gap:10px}
    .toast.show{display:flex;animation:fadeInUp 0.3s ease}
    @keyframes fadeInUp{from{opacity:0;transform:translate(-50%,20px)} to{opacity:1;transform:translate(-50%,0)}}
    .message-list{max-width:900px;margin:14px auto;padding:0 20px}
    .message{background:var(--card);padding:12px;border-radius:10px;margin-bottom:10px}
    .reply-area{display:flex;gap:8px;margin-top:8px}
    .public-badge{background:#e6f4ff;padding:2px 8px;border-radius:999px;font-size:0.8rem}
    footer{padding:20px;text-align:center;color:var(--muted)}
    @media (max-width:900px){ header{padding:12px} .hero h2{font-size:1.6rem} .admin-panel{width:100%} }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden>U</div>
      <div>
        <h1>Unseen</h1>
        <div class="muted" style="font-size:12px">رسائل مجهولة — خصوصية أولاً</div>
      </div>
    </div>

    <nav aria-label="القائمة الرئيسية">
      <a href="#features">المزايا</a>
      <a href="#testimonials">آراء</a>
      <a href="#faq">الأسئلة</a>
      <a href="#contact" id="contact-link">تواصل</a>
      <a href="#" id="my-dashboard-link" style="display:none">لوحة التحكم</a>
    </nav>

    <div class="controls">
      <button class="icon-btn" id="theme-toggle" title="تبديل الثيم"><span class="material-icons">dark_mode</span></button>
      <button class="icon-btn" id="profile-copy" title="انسخ رابط ملفك"><span class="material-icons">link</span></button>

      <!-- Firebase auth controls -->
      <button class="icon-btn" id="auth-btn" title="تسجيل/حساب"><span class="material-icons">person</span></button>
      <button class="icon-btn" id="signout-btn" title="تسجيل خروج" style="display:none"><span class="material-icons">logout</span></button>
      <button class="icon-btn" id="hamburger" aria-label="قائمة"> <span class="material-icons">menu</span></button>
    </div>
  </header>

  <main>
    <section class="hero" id="home">
      <div class="hero-inner">
        <div style="text-align:center">
          <span class="eyebrow">جديد</span>
          <h2 id="hero-title">قلها. وأنت غير مرئي.</h2>
          <p id="hero-subtext">احصل على رسائل مجهولة من أصدقائك — ممتعة، حقيقية، وخاصة دائمًا.</p>

          <div class="hero-actions">
            <button class="btn btn-primary" id="cta-btn"><span class="material-icons">send</span><span id="cta-text">ابدأ الآن</span></button>
            <div class="profile-link" title="رابط ملفك" id="profile-link">unseen.app/u/yourname <button id="copy-btn" class="icon-btn" style="margin-inline-start:6px"><span class="material-icons">content_copy</span></button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- place for public message form (route /u/:username will show this) -->
    <section id="public-form-section" style="display:none;padding:20px">
      <div style="max-width:700px;margin:0 auto;text-align:center">
        <h2 id="public-form-title">أرسل رسالة مجهولة</h2>
        <p class="muted" id="public-form-sub">ستبقى هويتك مخفية عن صاحب الملف — نستخدم بيانات المتصفح لمقاومة السبام فقط.</p>

        <form id="public-message-form" style="display:flex;flex-direction:column;gap:10px">
          <input id="pm-name" placeholder="اسم (اختياري)">
          <textarea id="pm-text" placeholder="اكتب رسالتك..." rows="5" required></textarea>
          <div style="display:flex;gap:8px;justify-content:center;align-items:center">
            <button class="btn btn-primary" type="submit">أرسل</button>
            <div class="muted" id="public-form-note">سيتم حفظ بيانات user-agent وIP لأغراض الحماية فقط.</div>
          </div>
        </form>
      </div>
    </section>

    <!-- dashboard (visible only when signed in) -->
    <section id="dashboard-section" style="display:none;padding:20px">
      <div style="max-width:1000px;margin:0 auto">
        <h2>لوحة الرسائل — صندوق الوارد</h2>
        <div class="message-list" id="message-list">جارٍ التحميل...</div>
      </div>
    </section>

    <!-- FAQ and other sections omitted for brevity (kept as original) -->
    <section class="features" id="features" aria-labelledby="features-title">
      <h2 id="features-title" style="grid-column:1/-1;text-align:center">مزايا Unseen</h2>
      <div class="card"><span class="material-icons">person_add</span><h3>أنشئ ملفك</h3><p>حساب سريع وبسيط مع إعدادات خصوصية متقدمة.</p></div>
      <div class="card"><span class="material-icons">link</span><h3>شارك الرابط</h3><p>انسخ رابط ملفك أو شاركه مباشرة عبر التطبيقات.</p></div>
      <div class="card"><span class="material-icons">mail</span><h3>استقبل رسائل مجهولة</h3><p>واجهة قراءة آمنة ومريحة، مع فلترة للرسائل المسيئة.</p></div>
    </section>

    <footer>
      <div>© 2025 Unseen · جميع الحقوق محفوظة</div>
    </footer>
  </main>

  <div class="toast" id="toast"><span id="toast-message"></span></div>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

  <script>
/*
  IMPORTANT:
  - This front-end expects a Firebase project. Update the firebaseConfig below with your project's credentials.
  - The anonymous message sending is performed via a Firebase Cloud Function at the endpoint SEND_MESSAGE_ENDPOINT.
    You can deploy the function from the included functions/ folder.
  - For Hosting rewrites, you can map "/api/**" to your functions in firebase.json (included).
*/

/* ===== CONFIG ===== */
const SEND_MESSAGE_ENDPOINT = '/api/sendMessage'; // when using Firebase Hosting rewrites this points to functions
const firebaseConfig = {
  apiKey: "REPLACE_WITH_YOUR_API_KEY",
  authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",
  projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
  storageBucket: "REPLACE_WITH_YOUR_STORAGE_BUCKET",
  messagingSenderId: "REPLACE_WITH_YOUR_SENDER_ID",
  appId: "REPLACE_WITH_YOUR_APP_ID",
  measurementId: ""
};
/* ================== */

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const functions = firebase.functions();

const toast = document.getElementById('toast');
const toastMessage = document.getElementById('toast-message');
function showToast(msg, dur=3000){ toastMessage.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), dur); }

/* Simple router: if path starts with /u/username show public form and set targetUsername */
let currentTargetUsername = null;
function parsePathAndRender(){
  const path = location.pathname || '/';
  if(path.startsWith('/u/')){
    currentTargetUsername = decodeURIComponent(path.split('/u/')[1].split('/')[0] || '').replace(/[^a-zA-Z0-9_\-\.]/g,'');
    if(!currentTargetUsername){ document.getElementById('public-form-section').style.display='none'; return; }
    document.getElementById('home').style.display='none';
    document.getElementById('public-form-section').style.display='block';
    document.getElementById('public-form-title').textContent = `أرسل رسالة إلى ${currentTargetUsername}`;
  } else {
    document.getElementById('public-form-section').style.display='none';
    document.getElementById('home').style.display='block';
  }
}
window.addEventListener('popstate', parsePathAndRender);
parsePathAndRender();

/* Copy profile link: reads profile-link text (user needs to be logged in) */
document.getElementById('copy-btn').addEventListener('click', async ()=>{
  const text = document.getElementById('profile-link').innerText.trim();
  try{ await navigator.clipboard.writeText(text); showToast('تم نسخ الرابط'); }catch(e){ showToast('فشل النسخ'); }
});

/* PUBLIC MESSAGE FORM: sends to cloud function which stores message and IP (IP saved in moderation-only doc) */
const publicForm = document.getElementById('public-message-form');
publicForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentTargetUsername){ showToast('الرابط غير صالح'); return; }
  const name = document.getElementById('pm-name').value.trim() || null;
  const text = document.getElementById('pm-text').value.trim();
  if(!text){ showToast('اكتب رسالة'); return; }

  const payload = {
    targetUsername: currentTargetUsername,
    name,
    text,
    userAgent: navigator.userAgent || null,
    origin: location.origin
  };

  try{
    const res = await fetch(SEND_MESSAGE_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const json = await res.json();
    if(!res.ok){ throw new Error(json.error || json.message || 'خطأ'); }
    showToast('تم إرسال الرسالة — شكرًا لك!');
    publicForm.reset();
  }catch(err){
    console.error(err);
    showToast('فشل الإرسال: ' + (err.message || err));
  }
});

/* AUTH & DASHBOARD */
const authBtn = document.getElementById('auth-btn');
const signoutBtn = document.getElementById('signout-btn');
const myDashboardLink = document.getElementById('my-dashboard-link');

authBtn.addEventListener('click', async ()=>{
  // simple email sign in flow (prompt). In production replace with full modal / OAuth
  const email = prompt('البريد الإلكتروني');
  if(!email) return;
  const password = prompt('كلمة المرور');
  if(!password) return;
  try{
    await auth.signInWithEmailAndPassword(email, password);
  }catch(err){
    if(err.code === 'auth/user-not-found'){
      try{
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        // create user doc
        await db.collection('users').doc(cred.user.uid).set({
          uid: cred.user.uid,
          username: email.split('@')[0].replace(/[^a-z0-9_-]/gi,'') || ('user'+Math.floor(Math.random()*9000+1000)),
          email, createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, {merge:true});
      }catch(e){ showToast('خطأ التسجيل: ' + e.message); }
    } else {
      showToast('خطأ تسجيل الدخول: ' + err.message);
    }
  }
});

signoutBtn.addEventListener('click', async ()=>{
  await auth.signOut();
});

/* On auth change: show dashboard link and update profile link */
auth.onAuthStateChanged(async (user)=>{
  if(user){
    signoutBtn.style.display = 'inline-flex';
    authBtn.style.display = 'none';
    myDashboardLink.style.display = 'inline-block';
    // fetch username
    const doc = await db.collection('users').doc(user.uid).get();
    const username = (doc.exists && doc.data().username) ? doc.data().username : user.uid;
    document.getElementById('profile-link').innerHTML = `unseen.app/u/${username} <button id="copy-btn2" class="icon-btn" style="margin-inline-start:6px"><span class="material-icons">content_copy</span></button>`;
    // reattach copy
    const cb2 = document.getElementById('copy-btn2');
    if(cb2) cb2.addEventListener('click', async ()=>{ try{ await navigator.clipboard.writeText(`https://${location.host}/u/${username}`); showToast('تم نسخ الرابط'); }catch(e){ showToast('فشل النسخ'); } });

    // show dashboard
    myDashboardLink.onclick = (e)=>{ e.preventDefault(); openDashboard(); };
    // auto-open dashboard when visiting /dashboard
    if(location.pathname === '/dashboard') openDashboard();
  } else {
    signoutBtn.style.display = 'none';
    authBtn.style.display = 'inline-flex';
    myDashboardLink.style.display = 'none';
    document.getElementById('profile-link').textContent = 'unseen.app/u/yourname ';
  }
});

/* Dashboard: load user's inbox (messages) but DO NOT reveal IP or userAgent to recipient.
   The function that writes messages stores IP in moderation collection only.
*/
async function openDashboard(){
  const user = auth.currentUser;
  if(!user){ showToast('سجل الدخول لعرض لوحة التحكم'); return; }
  document.getElementById('home').style.display='none';
  document.getElementById('public-form-section').style.display='none';
  document.getElementById('dashboard-section').style.display='block';
  const listEl = document.getElementById('message-list');
  listEl.innerHTML = 'جارٍ التحميل...';
  try{
    const snap = await db.collection('users').doc(user.uid).collection('inbox').orderBy('createdAt','desc').get();
    if(snap.empty){ listEl.innerHTML = '<div class="muted">لا توجد رسائل بعد.</div>'; return; }
    let html = '';
    snap.forEach(doc => {
      const d = doc.data();
      const text = d.text || '';
      const name = d.fromName || '';
      const created = (d.createdAt && d.createdAt.toDate) ? d.createdAt.toDate().toLocaleString() : '';
      const reply = d.replyText || null;
      const isPublic = !!d.postedPublic;
      const id = doc.id;
      html += `<div class="message" data-id="${id}">
        <div><strong>${name ? name : 'مجهول'}</strong> <span class="muted">· ${created}</span></div>
        <div style="margin-top:8px">${escapeHtml(text)}</div>
        ${ reply ? `<div style="margin-top:10px"><strong>ردك:</strong> ${escapeHtml(reply)}</div>` : '' }
        <div class="reply-area">
          <input placeholder="اكتب رد (اختياري)" data-reply-input="${id}">
          <button class="btn btn-primary" data-reply-btn="${id}">رد</button>
          <label style="display:inline-flex;align-items:center;gap:6px;margin-inline-start:10px"><input type="checkbox" data-public-checkbox="${id}"> انشر كقصة</label>
        </div>
      </div>`;
    });
    listEl.innerHTML = html;

    // attach reply handlers
    listEl.querySelectorAll('[data-reply-btn]').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = btn.getAttribute('data-reply-btn');
        const input = document.querySelector(`[data-reply-input="${id}"]`);
        const txt = input.value.trim();
        const postPublic = document.querySelector(`[data-public-checkbox="${id}"]`).checked;
        if(!txt){ showToast('اكتب الرد أولاً'); return; }
        try{
          // write reply into message doc under users/{uid}/inbox/{id}
          await db.collection('users').doc(auth.currentUser.uid).collection('inbox').doc(id).update({
            replyText: txt,
            repliedAt: firebase.firestore.FieldValue.serverTimestamp(),
            postedPublic: postPublic
          });
          if(postPublic){
            // also create a public post document (basic)
            await db.collection('posts').add({
              authorUid: auth.currentUser.uid,
              messageId: id,
              text: txt,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          }
          showToast('تم الرد');
          input.value = '';
          // refresh
          openDashboard();
        }catch(err){
          console.error(err); showToast('خطأ أثناء إرسال الرد: ' + err.message);
        }
      });
    });

  }catch(err){
    console.error(err); listEl.innerHTML = '<div class="muted">فشل التحميل</div>';
  }
}

/* Utility: escape HTML */
function escapeHtml(s){ if(!s) return ''; return s.replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

/* END */
  </script>
</body>
</html>
