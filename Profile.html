<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unseen — الملف الشخصي</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <style>
    :root{
      --primary:#5a3fff;
      --accent:#06b6d4;
      --muted:#64748b;
      --bg:#ffffff;
      --card:rgba(10,11,13,0.04);
      --radius:14px;
    }
    [dir="ltr"]{ --flow:row; }
    [dir="rtl"]{ --flow:row-reverse; }

    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, "Inter", sans-serif;
      background:var(--bg);
      color:#081029;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition:background .25s,color .25s;
    }
    body.dark{ --bg:#07102a; background:#07102a; color:#e6eef8; }

    header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{display:inline-grid;place-items:center;width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--accent));color:white;font-weight:700}
    .brand h1{margin:0;font-size:1.05rem}
    nav{display:flex;gap:12px;align-items:center}
    nav a{color:inherit;text-decoration:none;padding:8px 10px;border-radius:10px;font-weight:600}
    .controls{display:flex;gap:8px;align-items:center}
    .icon-btn{background:none;border:1px solid transparent;padding:8px;border-radius:10px;cursor:pointer}
    .icon-btn:hover{transform:translateY(-1px)}

    .container{max-width:800px;margin:0 auto;padding:20px}
    .profile-header{text-align:center;margin-bottom:30px}
    .profile-avatar{width:100px;height:100px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));color:white;display:grid;place-items:center;font-size:2.5rem;font-weight:700;margin:0 auto 15px}
    .profile-stats{display:flex;justify-content:center;gap:20px;margin:20px 0}
    .profile-stat{text-align:center}
    .profile-stat .number{font-size:1.5rem;font-weight:700}
    .profile-stat .label{color:var(--muted);font-size:0.9rem}
    
    .message-form{background:var(--card);padding:20px;border-radius:var(--radius);margin-bottom:30px}
    .form-group{margin-bottom:15px}
    textarea{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(8,16,41,0.1);font-family:inherit;resize:vertical;min-height:100px}
    .btn{display:inline-flex;gap:10px;align-items:center;padding:12px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700}
    .btn-primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:white}
    
    .messages-list{margin-top:30px}
    .message-card{background:var(--card);padding:15px;border-radius:var(--radius);margin-bottom:15px}
    .message-header{display:flex;justify-content:space-between;margin-bottom:10px}
    .message-date{color:var(--muted);font-size:0.85rem}
    
    .empty-state{text-align:center;padding:40px 0;color:var(--muted)}
    
    @media (max-width:768px){
      .profile-stats{flex-wrap:wrap}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo" aria-hidden>U</div>
      <div>
        <h1>Unseen</h1>
        <div class="muted" style="font-size:12px">رسائل مجهولة — خصوصية أولاً</div>
      </div>
    </div>

    <div class="controls">
      <button class="icon-btn" id="theme-toggle" title="تبديل الثيم"><span class="material-icons">dark_mode</span></button>
      <button class="icon-btn" id="home-btn" title="العودة للصفحة الرئيسية"><span class="material-icons">home</span></button>
    </div>
  </header>

  <main class="container">
    <div class="profile-header">
      <div class="profile-avatar" id="profile-avatar">?</div>
      <h2 id="profile-username">اسم المستخدم</h2>
      <p class="muted" id="profile-bio">لا توجد معلومات عن هذا المستخدم</p>
      
      <div class="profile-stats">
        <div class="profile-stat">
          <div class="number" id="messages-count">0</div>
          <div class="label">الرسائل</div>
        </div>
        <div class="profile-stat">
          <div class="number" id="profile-views">0</div>
          <div class="label">المشاهدات</div>
        </div>
      </div>
    </div>

    <div class="message-form">
      <h3>أرسل رسالة مجهولة</h3>
      <form id="send-message-form">
        <div class="form-group">
          <textarea id="message-text" placeholder="اكتب رسالتك هنا..." required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">send</span>
          أرسل الرسالة
        </button>
      </form>
    </div>

    <div class="messages-list" id="messages-list">
      <div class="empty-state" id="empty-state">
        <span class="material-icons" style="font-size:48px">inbox</span>
        <h3>لا توجد رسائل حتى الآن</h3>
        <p>كن أول من يرسل رسالة إلى هذا المستخدم</p>
      </div>
    </div>
  </main>

  <!-- Toast notification -->
  <div class="toast" id="toast">
    <span id="toast-message"></span>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB7uWrWJ1v_o3fqx0442wIkrAfTnPn84Mo",
      authDomain: "unseen-93dd8.firebaseapp.com",
      projectId: "unseen-93dd8",
      storageBucket: "unseen-93dd8.firebasestorage.app",
      messagingSenderId: "142670337449",
      appId: "1:142670337449:web:f41e9b5ebbb433378060b8",
      measurementId: "G-SPL7YN9LZ1"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // DOM Elements
    const themeToggle = document.getElementById('theme-toggle');
    const homeBtn = document.getElementById('home-btn');
    const profileAvatar = document.getElementById('profile-avatar');
    const profileUsername = document.getElementById('profile-username');
    const profileBio = document.getElementById('profile-bio');
    const messagesCount = document.getElementById('messages-count');
    const profileViews = document.getElementById('profile-views');
    const sendMessageForm = document.getElementById('send-message-form');
    const messageText = document.getElementById('message-text');
    const messagesList = document.getElementById('messages-list');
    const emptyState = document.getElementById('empty-state');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toast-message');

    // الحصول على اسم المستخدم من رابط الصفحة
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('u');
    
    if (!username) {
      showToast('لم يتم تحديد مستخدم', 3000);
      // يمكن توجيه المستخدم للصفحة الرئيسية بعد فترة
      setTimeout(() => { window.location.href = 'index.html'; }, 3000);
    }

    // إظهار إشعار Toast
    function showToast(message, duration = 3000) {
      toastMessage.textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }

    // تحميل بيانات الملف الشخصي
    async function loadProfileData() {
      try {
        // البحث عن المستخدم بالاسم
        const usersSnapshot = await db.collection('users')
          .where('username', '==', username)
          .get();
          
        if (usersSnapshot.empty) {
          showToast('المستخدم غير موجود', 3000);
          setTimeout(() => { window.location.href = 'index.html'; }, 3000);
          return;
        }
        
        const userDoc = usersSnapshot.docs[0];
        const userData = userDoc.data();
        
        // عرض بيانات المستخدم
        profileAvatar.textContent = userData.username ? userData.username.charAt(0).toUpperCase() : '?';
        profileUsername.textContent = userData.username || 'مستخدم بدون اسم';
        profileBio.textContent = userData.bio || 'لا توجد معلومات عن هذا المستخدم';
        
        // زيادة عداد المشاهدات
        await db.collection('users').doc(userDoc.id).update({
          profileViews: (userData.profileViews || 0) + 1
        });
        
        profileViews.textContent = (userData.profileViews || 0) + 1;
        
        // تحميل الرسائل
        loadUserMessages(userDoc.id);
        
      } catch (error) {
        console.error('Error loading profile:', error);
        showToast('حدث خطأ في تحميل البيانات', 3000);
      }
    }
    
    // تحميل رسائل المستخدم
    async function loadUserMessages(userId) {
      try {
        const messagesSnapshot = await db.collection('messages')
          .where('recipientId', '==', userId)
          .orderBy('createdAt', 'desc')
          .get();
          
        messagesCount.textContent = messagesSnapshot.size;
        
        if (messagesSnapshot.empty) {
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        
        messagesSnapshot.forEach(doc => {
          const message = doc.data();
          const messageElement = document.createElement('div');
          messageElement.className = 'message-card';
          
          const date = message.createdAt ? message.createdAt.toDate() : new Date();
          const formattedDate = date.toLocaleDateString('ar-SA');
          
          messageElement.innerHTML = `
            <div class="message-header">
              <strong>مرسل مجهول</strong>
              <span class="message-date">${formattedDate}</span>
            </div>
            <p>${message.text}</p>
          `;
          
          messagesList.appendChild(messageElement);
        });
        
      } catch (error) {
        console.error('Error loading messages:', error);
        showToast('حدث خطأ في تحميل الرسائل', 3000);
      }
    }
    
    // إرسال رسالة جديدة
    sendMessageForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const text = messageText.value.trim();
      if (!text) {
        showToast('اكتب رسالة أولاً', 3000);
        return;
      }
      
      try {
        // البحث عن المستخدم بالاسم
        const usersSnapshot = await db.collection('users')
          .where('username', '==', username)
          .get();
          
        if (usersSnapshot.empty) {
          showToast('المستخدم غير موجود', 3000);
          return;
        }
        
        const userDoc = usersSnapshot.docs[0];
        const userData = userDoc.data();
        
        // حفظ الرسالة في قاعدة البيانات
        await db.collection('messages').add({
          recipientId: userDoc.id,
          text: text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // زيادة عداد الرسائل
        await db.collection('users').doc(userDoc.id).update({
          messageCount: (userData.messageCount || 0) + 1
        });
        
        showToast('تم إرسال الرسالة بنجاح', 3000);
        messageText.value = '';
        
        // إعادة تحميل الرسائل
        messagesList.innerHTML = '';
        emptyState.style.display = 'none';
        loadUserMessages(userDoc.id);
        
      } catch (error) {
        console.error('Error sending message:', error);
        showToast('حدث خطأ في إرسال الرسالة', 3000);
      }
    });
    
    // تبديل الوضع الليلي
    themeToggle.addEventListener('click', () => { 
      document.body.classList.toggle('dark');
      if (document.body.classList.contains('dark')) {
        themeToggle.querySelector('span').textContent = 'light_mode';
        localStorage.setItem('theme', 'dark');
      } else {
        themeToggle.querySelector('span').textContent = 'dark_mode';
        localStorage.setItem('theme', 'light');
      }
    });
    
    // العودة للصفحة الرئيسية
    homeBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });
    
    // تحميل الإعدادات عند بدء التشغيل
    function loadSettings() {
      const savedTheme = localStorage.getItem('theme');
      if (savedTheme === 'dark') {
        document.body.classList.add('dark');
        themeToggle.querySelector('span').textContent = 'light_mode';
      }
    }
    
    // بدء التحميل
    loadSettings();
    if (username) {
      loadProfileData();
    }
  </script>
</body>
</html>
